# Ping

使用的是ICMP协议（Internet控制消息协议），是TCP/IP协议族的一个子协议，用于在IP主机、路由器之间传递控制消息。

### ping流程

**同一个局域网中：**

1. Pc1在**应用层**发起个目标IP位IP2的Ping请求。
2. **传输层**接到上层请求的数据，将数据分段并加上UDP报头。下传到**网际层**。 
3. **网际层**接收来处上层的数据后，根据ICMP协议进行封装，添加PC1的IP为源IP为和PC2IP为目标IP后封装成数据包。下传到**网络接口层**。 
4. **网络接口层**接收数据包后，进行封装，源MAC地址为PC1的MAC地址，目标MAC地址则查询自己的ARP缓存表获取。如果PC1 arp缓存表中没有目标IP对应的MAC地址，则PC1发出一个ARP广播报文。ARP报文中源MAC地址为Pc1mac地址，源IP地址为pc1 IP，所要请求的是PC2的IP对应的mac地址。 
5. PC2收到ARP广播后，进行解封装，发现所请求的MAC地址是自己的。则PC2将PC1的mac地址写入arp缓存表中。然后向PC1发送一个 ARP应答单播。该单播消息包括目标IP为PC1ip，目标Mac为pc1mac地址，源IP为PC2的IP，源Mac为pc2的Mac。 
6. Pc1接收到PC2的arp应答报文后，将Pc2的MAC地址存入arp缓存中，并将Pc2的Mac地址作为目标地址封装到数据帧中。发给下层进行网络传输。 
7. PC2接收这个帧后，在**网络接口层**查看目标mac地址是否指向自己。是，PC2则将帧头去掉，向上层传输。 
8. Pc2**网际层**接收到这个信息包，查看包头，发现目标IP和自己匹配，则解封装，将数据向上层传输。 
9. **传输层**接收来自下层的Ping请求的UDP报文，则去掉UDP报头，向**应用层**传送。 
10. **应用层**收到ping请求后，发送一个PIng回应报文给PC1

**不同网段**

1. ping通知系统建立一个固定格式的ICMP请求数据包

2. ICMP协议打包这个数据包和机器B的IP地址转交给IP协议层（一组后台运行的进程，与ICMP类似）

3. IP层协议将以机器B的IP地址为目的地址，本机IP地址为源地址，加上一些其他的控制信息，构建一个IP数据包

4. 获取主机B的MAC地址

   * IP协议通过计算发现主机B与自己不在同一网段内，就直接交给路由处理，就是将路由的MAC取过来，至于怎么得到路由的MAC地址，和之前一样，先在ARP缓存表中寻找，找不到可以利用广播。路由得到这个数据帧之后，再跟主机B联系，若找不到，就向主机A返回一个超时信息。

![](/assets/20151129142314061.JPG)

## ICMP协议 {#icmp协议：}

1\) ICMP允许主机或路由报告差错情况和提供有关异常情况。ICMP是因特网的标准协议，但ICMP不是高层协议，而是IP层的协议。通常ICMP报文被IP层或更高层协议（TCP或UDP）使用。一些ICMP报文把差错报文返回给用户进程。 2\) ICMP报文作为IP层数据报的数据，加上数据报的首部，组成数据报发送出去。 3\) ICMP报文的种类有两种，即ICMP差错报告报文和ICMP询问报文。

