### HTT工作流程

一次HTTP操作称为一个事务，其工作整个过程如下：

1 \) **地址解析**

如用客户端浏览器请求这个页面：[http://localhost.com:8080/index.htm](http://localhost:8080/simple.htm)l

从中分解出协议名、主机名、端口、对象路径等部分，对于我们的这个地址，解析得到的结果如下：  
协议名：http  
主机名：localhost.com  
端口：8080  
对象路径：/index.htm

在这一步，需要域名系统DNS解析域名localhost.com,得主机的IP地址。

2）**封装HTTP请求数据包**

把以上部分结合本机自己的信息，封装成一个HTTP请求数据包。  
3）**封装成TCP包，建立TCP长连接（TCP的三次握手）**

在HTTP工作开始之前，客户机（Web浏览器）首先要通过网络与服务器建立连接，该连接是通过TCP来完成的，该协议与IP协议共同构建Internet，即著名的TCP/IP协议族，因此Internet又被称作是TCP/IP网络。HTTP是比TCP更高层次的应用层协议，根据规则，只有低层协议建立之后，才能进行更层次协议的连接，因此，首先要建立TCP连接，一般TCP连接的端口号是80。这里是8080端口。

4）**客户机发送请求命令**

建立连接后，客户机发送一个请求给服务器，请求方式的格式为：统一资源标识符（URL）、协议版本号，后边是MIME信息包括请求修饰符、客户机信息和可内容。

5）**服务器响应**

服务器接到请求后，给予相应的响应信息，其格式为一个状态行，包括信息的协议版本号、一个成功或错误的代码，后边是MIME信息包括服务器信息、实体信息和可能的内容。

实体消息是服务器向浏览器发送头信息后，它会发送一个空白行来表示头信息的发送到此为结束，接着，它就以Content-Type应答头信息所描述的格式发送用户所请求的实际数据。

6）**服务器关闭TCP连接**

一般情况下，一旦Web服务器向浏览器发送了请求数据，它就要关闭TCP连接，然后如果浏览器或者服务器在其头信息加入了这行代码Connection:keep-alive。TCP连接在发送后将仍然保持打开状态，于是，浏览器可以继续通过相同的连接发送请求。保持连接节省了为每个请求建立新连接所需的时间，还节约了网络带宽。

#### HTTP长连接

client和server建立连接，完成一次读写之后，它们之间的连接并不会主动关闭，后续的读写操作会继续使用这个连接。

当使用 Keep-Alive 模式（又称持久连接、连接重用）时，Keep-Alive 功能使客户端到服务器端的连接持续有效，当出现对服务器的后继请求时，Keep-Alive 功能避免了建立或者重新建立连接。（HTTP 1.0 在请求头中加：Connection: Keep-Alive，HTTP 1.1默认发起的都是长连接）

TCP保活功能主要为探测长连接的存活状况。保活：如果一个给定的连接在两小时内没有任何的动作，则服务器就向客户发一个探测报文段。

适用于客户端和服务端通信频繁的场景，例如聊天室，实时游戏等。

#### HTTP短连接

一般只会在client/server间传递一次读写操作。

HTTP 协议采用“请求-应答”模式，当使用普通模式，即非 Keep-Alive 模式时，每个请求/应答客户和服务器都要新建一个连接，完成之后立即断开连接。（HTTP 1.1 中加：Connection: close）

优点：管理起来比较简单，存在的连接都是有用的连接，不需要额外的控制手段

适用于网页浏览等数据刷新频度较低的场景。

#### HTTP断点续传

HTTP协议中定义了断点续传相关的HTTP头 Range和Content-Range字段。

1. 客户端下载一个1024K的文件，已经下载了其中512K 
2. 网络中断，客户端请求续传，因此需要在HTTP头中申明本次需要续传的片段：Range:bytes=512000-

   这个头通知服务端从文件的512K位置开始传输文件

3. 服务端收到断点续传请求，从文件的512K位置开始传输，并且在HTTP头中增加：  
   Content-Range:bytes 512000-/1024000。并且此时服务端返回的HTTP状态码应该是206，而不是200。

## HTTP请求报文

![](/assets/importhttp.png)

HTTP请求包括三部分：

1. **请求行**\(Request Line\)：由请求方法\(method\)，请求URL和协议\(Protocol\)版本构成。如：GET /index.html HTTP/1.1
2. 请求**头部**（Header）：请求头部通知服务器有关于客户端请求的信息，包括：
   1. User-Agent：产生请求的浏览器类型的详细信息。
   2. Accept：指定客户端能够接收的内容类型。
   3. Host：请求的web服务器域名地址。
   4. connection：是否需要持久连接，值为“Keep - Alive” 或 HTTP 1.1默认为长连接。
   5. Content-Type:表示具体请求中的媒体类型信息。在HTTP中，MIME类型被定义在Content-Type     header中。每个MIME类型由两部分组成，前面是数据的大类别，例如声音audio、图象image等，后面定义具体的种类。

   6. cookie
3. 空行
4. **实体内容**（Body\)：可以被认为是附加在请求之后的文本或二进制文件，只有请求方式为post的时候，实体内容才会有数据。

#### content-type

MediaType，即是Internet MediaType，互联网媒体类型；也叫做MIME类型，  
在Http协议消息头中，使用Content-Type来表示具体请求中的媒体类型信息。

在HTTP中，MIME类型被定义在Content-Type     header中。每个MIME类型由两部分组成，前面是数据的大类别，  
例如声音audio、图象image等，后面定义具体的种类。

#### HTTP请求方式

1. **get查询/获取**
   安全的：不修改信息
   幂等的：同一URL的多次请求有同样的结果。并没有那么严格。
   请求数据在url里，用?连接
   url会根据浏览器有不同长度限制，进而限制传送的数据量。
2. **post更新**
   可能修改服务器上的资源请求。
   请求数据在body中
   没限制，可传大量资源。
   安全性比get高，因为数据在url中可见。
3. Post提交数据的方式：  
   [http://www.cnblogs.com/softidea/p/5745369.html](http://www.cnblogs.com/softidea/p/5745369.html)  
   服务端通常是根据请求头（headers）中的 Content-Type 字段来获知请求中的消息主体是用何种方式编码，再对主体进行解析。POST 提交数据方案，包含了 Content-Type 和消息主体编码方式两部分。

   1. application/x-www-form-urlencoded
   2. multipart/form-data
   3. application/json
        告诉服务端消息主体是序列化后的 JSON 字符串
   4. text/xml

4. 条件GET

   HTTP 条件 GET 是 HTTP 协议为了减少不必要的带宽浪费，提出的一种方案。

   使用的时机：客户端之前已经访问过某网站，并打算再次访问该网站。

   客户端向服务器发送一个包询问是否在上一次访问网站的时间后是否更改了页面，如果服务器没有更新，显然不需要把整个网页传给客户端，客户端只要使用本地缓存即可，如果服务器对照客户端给出的时间已经更新了客户端请求的网页，则发送这个更新了的网页给用户。（服务器根据请求中的`If-Modified-Since`字段判断响应文件没有更新，如果没有更新，服务器返回一个`304 Not Modified`响应，如果服务器端资源已经更新的话，就返回正常的响应）

#### HTTP响应报文

状态行、响应头、响应正文。状态行包含：协议版本、数字形式的状态代码、及相应的状态描述。

&lt;status-line&gt;             状态行

&lt;headers&gt;                 响应头

&lt;blank line&gt;              空格

\[&lt;response-body&gt;\]   响应正文

#### 常见状态码

1XX 临时响应

2XX 成功

```
200 ok

201 created 服务器已经创建了文档

202 accept 已经接受请求，但处理未完成

203 非授权信息
```

3XX 重定向

```
301 Moved Permanently 请求永久重定向
302 Moved Temporarily 请求临时重定向
```

4XX 客户端请求错误

```
400 bad request   由于客户端请求有语法错误，不能被服务器所理解。

401 unauthorized  请求未经授权。这个状态代码必须和WWW-Authenticate报头域一起使用

403 forbidden     服务器收到请求，但是拒绝提供服务。

404 not found     请求的资源不存在，例如，输入了错误的URL

408 超时

409 冲突
```

5XX 服务器错误

```
500 internal server error 服务器发生不可预期的错误，导致无法完成客户端的请求。

503 Service Unavailable   服务器不可用 服务器当前不能够处理客户端的请求，在一段时间之后，服务器可能会恢复正常。
```



